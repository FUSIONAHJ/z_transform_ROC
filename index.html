<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Z-Transform ROC Visualizer (Offline)</title>
    <style>
    /* Reset & Base */
    *, ::before, ::after { box-sizing: border-box; border-width: 0; border-style: solid; border-color: #e5e7eb; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; background-color: #f9fafb; color: #111827; }
    h1, h2, h3, h4 { font-weight: 700; margin: 0; }
    p { margin: 0; }
    button { cursor: pointer; background-color: transparent; font-family: inherit; }
    button:disabled { cursor: not-allowed; opacity: 0.5; }
    input { font-family: inherit; }
    
    /* Utility Classes (Simplified Tailwind) */
    .min-h-screen { min-height: 100vh; }
    .max-w-7xl { max-width: 80rem; }
    .mx-auto { margin-left: auto; margin-right: auto; }
    .px-4 { padding-left: 1rem; padding-right: 1rem; }
    .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
    .py-8 { padding-top: 2rem; padding-bottom: 2rem; }
    .pb-12 { padding-bottom: 3rem; }
    .flex { display: flex; }
    .flex-col { display: flex; flex-direction: column; }
    .items-center { align-items: center; }
    .justify-between { justify-content: space-between; }
    .justify-center { justify-content: center; }
    .gap-2 { gap: 0.5rem; }
    .gap-3 { gap: 0.75rem; }
    .gap-6 { gap: 1.5rem; }
    .gap-8 { gap: 2rem; }
    .space-y-4 > :not([hidden]) ~ :not([hidden]) { margin-top: 1rem; }
    .space-y-3 > :not([hidden]) ~ :not([hidden]) { margin-top: 0.75rem; }
    .space-y-1 > :not([hidden]) ~ :not([hidden]) { margin-top: 0.25rem; }
    .grid { display: grid; }
    .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
    .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    @media (min-width: 768px) { .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (min-width: 1024px) { 
        .lg\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        .lg\:col-span-2 { grid-column: span 2 / span 2; }
        .lg\:col-span-1 { grid-column: span 1 / span 1; }
    }
    .bg-white { background-color: white; }
    .bg-gray-50 { background-color: #f9fafb; }
    .bg-gray-100 { background-color: #f3f4f6; }
    .bg-gray-200 { background-color: #e5e7eb; }
    .bg-gray-900 { background-color: #111827; }
    .bg-blue-600 { background-color: #2563eb; }
    .bg-blue-50 { background-color: #eff6ff; }
    .bg-blue-200 { background-color: #bfdbfe; }
    .bg-red-50 { background-color: #fef2f2; }
    .bg-yellow-50 { background-color: #fefce8; }
    .bg-indigo-50 { background-color: #eef2ff; }
    .bg-green-50 { background-color: #f0fdf4; }
    .text-white { color: white; }
    .text-gray-900 { color: #111827; }
    .text-gray-800 { color: #1f2937; }
    .text-gray-700 { color: #374151; }
    .text-gray-600 { color: #4b5563; }
    .text-gray-500 { color: #6b7280; }
    .text-gray-400 { color: #9ca3af; }
    .text-blue-600 { color: #2563eb; }
    .text-blue-700 { color: #1d4ed8; }
    .text-blue-800 { color: #1e40af; }
    .text-indigo-600 { color: #4f46e5; }
    .text-indigo-800 { color: #3730a3; }
    .text-indigo-900 { color: #312e81; }
    .text-yellow-800 { color: #854d0e; }
    .text-yellow-900 { color: #713f12; }
    .text-green-800 { color: #166534; }
    .text-red-600 { color: #dc2626; }
    .border { border-width: 1px; }
    .border-b { border-bottom-width: 1px; }
    .border-l-4 { border-left-width: 4px; }
    .border-t { border-top-width: 1px; }
    .border-gray-100 { border-color: #f3f4f6; }
    .border-gray-200 { border-color: #e5e7eb; }
    .border-red-200 { border-color: #fecaca; }
    .border-blue-200 { border-color: #bfdbfe; }
    .border-indigo-500 { border-color: #6366f1; }
    .border-blue-500 { border-color: #3b82f6; }
    .border-yellow-500 { border-color: #eab308; }
    .border-green-200 { border-color: #bbf7d0; }
    .rounded { border-radius: 0.25rem; }
    .rounded-lg { border-radius: 0.5rem; }
    .rounded-xl { border-radius: 0.75rem; }
    .rounded-full { border-radius: 9999px; }
    .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    .shadow-sm { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
    .w-full { width: 100%; }
    .h-full { height: 100%; }
    .w-4 { width: 1rem; }
    .h-4 { height: 1rem; }
    .w-8 { width: 2rem; }
    .h-8 { height: 2rem; }
    .h-2 { height: 0.5rem; }
    .w-2 { width: 0.5rem; }
    .w-10 { width: 2.5rem; }
    .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
    .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
    .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
    .text-xs { font-size: 0.75rem; line-height: 1rem; }
    .font-bold { font-weight: 700; }
    .font-medium { font-weight: 500; }
    .font-semibold { font-weight: 600; }
    .font-mono { font-family: ui-monospace, monospace; }
    .italic { font-style: italic; }
    .uppercase { text-transform: uppercase; }
    .tracking-wide { letter-spacing: 0.025em; }
    .text-center { text-align: center; }
    .text-right { text-align: right; }
    .text-left { text-align: left; }
    .cursor-move { cursor: move; }
    .cursor-pointer { cursor: pointer; }
    .overflow-x-auto { overflow-x: auto; }
    .overflow-y-auto { overflow-y: auto; }
    .max-h-32 { max-height: 8rem; }
    .min-h-0 { min-height: 0; }
    .flex-1 { flex: 1 1 0%; }
    .pr-2 { padding-right: 0.5rem; }
    .-mr-2 { margin-right: -0.5rem; }
    .relative { position: relative; }
    .select-none { user-select: none; }
    .p-2 { padding: 0.5rem; }
    .p-3 { padding: 0.75rem; }
    .p-4 { padding: 1rem; }
    .p-6 { padding: 1.5rem; }
    .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
    .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
    .px-4 { padding-left: 1rem; padding-right: 1rem; }
    .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
    .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
    .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
    .mb-2 { margin-bottom: 0.5rem; }
    .mb-3 { margin-bottom: 0.75rem; }
    .mb-4 { margin-bottom: 1rem; }
    .mt-1 { margin-top: 0.25rem; }
    .mt-auto { margin-top: auto; }
    .pt-4 { padding-top: 1rem; }
    .accent-blue-600 { accent-color: #2563eb; }
    .appearance-none { -webkit-appearance: none; appearance: none; }
    .group:hover .group-hover-stroke-red { stroke: #dc2626; }
    .group:hover .group-hover-stroke-blue { stroke: #2563eb; }
    #zplane-container { width: 100%; max-width: 500px; margin: 0 auto; }
    #zplane-svg { display: block; margin: 0 auto; width: 100%; height: auto; }
  </style>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>

    <div id="gatekeeper" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(17,24,39,0.98); z-index: 99999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; text-align: center; backdrop-filter: blur(5px);">
        
        <div style="background: white; width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
            <span style="font-size: 30px; font-weight: bold; color: #2563eb;">Z</span>
        </div>

        <h1 style="color: #fff; margin-bottom: 10px; font-size: 24px;">Z-Transform ROC Visualizer</h1>
        <p style="color: #9ca3af; max-width: 400px; margin-bottom: 30px; font-size: 14px;">
            交互式零极点与收敛域分析工具。<br>
            如您是校外学习者，请购买离线正式版。
        </p>
        
        <div style="margin-bottom: 40px; padding: 25px; border: 1px solid #3b82f6; border-radius: 12px; background: rgba(37, 99, 235, 0.1); width: 90%; max-width: 350px;">
            <h3 style="margin-top: 0; color: #60a5fa; font-size: 18px;">获取完整离线版 (Windows/Mac)</h3>
            <ul style="text-align: left; font-size: 14px; color: #d1d5db; margin-bottom: 20px; line-height: 1.6;">
                <li>✅ 任意添加/拖动零极点</li>
                <li>✅ 实时生成时域响应 h[n]</li>
                <li>✅ 自动判别系统稳定性</li>
            </ul>
            <a href="https://mianbaoduo.com/o/你的链接" target="_blank" style="display:block; background: #2563eb; color: white; padding: 12px 30px; text-decoration: none; border-radius: 6px; font-weight: bold; font-size: 16px; transition: 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.2);">
                即将上线
            </a>
        </div>

        <div style="border-top: 1px solid #374151; padding-top: 20px; width: 300px;">
            <p style="font-size: 13px; color: #9ca3af; margin-bottom: 10px;">本校学生请输入课程口令：</p>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <input type="text" id="passInput" placeholder="输入口令" style="padding: 10px; border-radius: 6px; border: 1px solid #4b5563; background: #1f2937; color: white; outline: none; flex: 1;">
                <button onclick="checkPass()" style="padding: 10px 20px; border-radius: 6px; background: #4b5563; color: white; font-weight: bold; transition: background 0.2s;">解锁</button>
            </div>
            <p id="errorMsg" style="color: #ef4444; font-size: 12px; margin-top: 10px; display: none;">口令错误</p>
        </div>
    </div>

    <script>
        // === 配置区域 ===
        // "2526123" 的 Base64 编码
        const ENCRYPTED_KEY = "MjUyNjEyMw=="; 
        // ===============

        function unlock() {
            const gate = document.getElementById('gatekeeper');
            gate.style.opacity = '0';
            gate.style.transition = 'opacity 0.5s ease';
            setTimeout(() => {
                gate.style.display = 'none';
            }, 500); 
            
            // 存入缓存
            localStorage.setItem('course_auth_z_transform', ENCRYPTED_KEY);
        }

        function checkPass() {
            const input = document.getElementById('passInput').value;
            const errorMsg = document.getElementById('errorMsg');
            const btn = document.querySelector('#gatekeeper button');
            
            try {
                if (btoa(input) === ENCRYPTED_KEY) {
                    unlock();
                } else {
                    throw new Error();
                }
            } catch (e) {
                errorMsg.style.display = 'block';
                const inputEl = document.getElementById('passInput');
                inputEl.style.borderColor = '#ef4444';
                // 简单的震动动画
                inputEl.animate([
                    { transform: 'translateX(0)' },
                    { transform: 'translateX(-5px)' },
                    { transform: 'translateX(5px)' },
                    { transform: 'translateX(0)' }
                ], { duration: 300 });
            }
        }

        // 自动检测逻辑
        (function initAuth() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlKey = urlParams.get('auth');
            const cachedToken = localStorage.getItem('course_auth_z_transform');

            // 验证 URL 参数 (先加密再比对)
            if (urlKey && btoa(urlKey) === ENCRYPTED_KEY) {
                unlock();
                return;
            }

            // 验证缓存
            if (cachedToken === ENCRYPTED_KEY) {
                document.getElementById('gatekeeper').style.display = 'none';
            }
        })();
    </script>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- ICONS ---
        const PlusIcon = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>;
        const TrashIcon = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>;

        // --- CONSTANTS & TYPES ---
        const SequenceType = {
          RIGHT_SIDED: 'Right-Sided (Causal)',
          LEFT_SIDED: 'Left-Sided (Anti-Causal)',
          TWO_SIDED: 'Two-Sided'
        };
        const SVG_SIZE = 500;
        const CENTER = SVG_SIZE / 2;
        const UNIT_RADIUS = 150;

        // --- MATH UTILS (with Complex) ---
        const screenToLogical = (x, y) => ({ x: (x - CENTER) / UNIT_RADIUS, y: -(y - CENTER) / UNIT_RADIUS });
        const logicalToScreen = (x, y) => ({ x: CENTER + x * UNIT_RADIUS, y: CENTER - y * UNIT_RADIUS });
        const getMagnitude = (p) => Math.sqrt(p.x * p.x + p.y * p.y);
        const getAngle = (p) => Math.atan2(p.y, p.x);
        
        // Complex Ops
        const cAdd = (a, b) => ({ re: a.re + b.re, im: a.im + b.im });
        const cSub = (a, b) => ({ re: a.re - b.re, im: a.im - b.im });
        const cMul = (a, b) => ({ re: a.re * b.re - a.im * b.im, im: a.re * b.im + a.im * b.re });
        const cDiv = (a, b) => {
            const denom = b.re * b.re + b.im * b.im;
            if (denom === 0) return { re: 0, im: 0 };
            return { re: (a.re * b.re + a.im * b.im) / denom, im: (a.im * b.re - a.re * b.im) / denom };
        };
        const toComplex = (p) => ({ re: p.position.x, im: p.position.y });
        const complexPow = (mag, angle, n) => {
            if (mag === 0) return { re: 0, im: 0 };
            if (Math.abs(n) > 50 && mag > 1.1) return { re: Infinity, im: Infinity };
            const r = Math.pow(mag, n);
            const theta = angle * n;
            return { re: r * Math.cos(theta), im: r * Math.sin(theta) };
        };

        // --- COMPONENTS ---
        
        const ZPlane = ({ poles, zeros, sequenceType, onUpdatePoles, onUpdateZeros }) => {
            const svgRef = useRef(null);
            const [draggingItem, setDraggingItem] = useState(null);

            const magnitudes = poles.map(p => p.magnitude);
            const maxMag = magnitudes.length > 0 ? Math.max(...magnitudes) : 0;
            const minMag = magnitudes.length > 0 ? Math.min(...magnitudes) : 0;

            const handleMouseDown = (id, type, e) => {
                e.stopPropagation();
                setDraggingItem({ id, type });
            };

            const handleMouseMove = (e) => {
                if (!draggingItem || !svgRef.current) return;
                const CTM = svgRef.current.getScreenCTM();
                const x = (e.clientX - CTM.e) / CTM.a;
                const y = (e.clientY - CTM.f) / CTM.d;
                const logicalPos = screenToLogical(x, y);
                const newMag = getMagnitude(logicalPos);
                const newAngle = getAngle(logicalPos);

                if (draggingItem.type === 'pole') {
                    const updated = poles.map(p => p.id === draggingItem.id ? { ...p, position: logicalPos, magnitude: newMag, angle: newAngle } : p);
                    onUpdatePoles(updated);
                } else {
                    const updated = zeros.map(z => z.id === draggingItem.id ? { ...z, position: logicalPos, magnitude: newMag, angle: newAngle } : z);
                    onUpdateZeros(updated);
                }
            };

            const handleMouseUp = () => setDraggingItem(null);

            const renderROC = () => {
                if (poles.length === 0) return null;
                const rMax = maxMag * UNIT_RADIUS;
                const rMin = minMag * UNIT_RADIUS;
                const rInf = SVG_SIZE * 1.5;
                if (sequenceType === SequenceType.RIGHT_SIDED) {
                  return <path d={`M ${CENTER-rInf} ${CENTER-rInf} H ${CENTER+rInf} V ${CENTER+rInf} H ${CENTER-rInf} Z M ${CENTER} ${CENTER-rMax} A ${rMax} ${rMax} 0 1 0 ${CENTER} ${CENTER+rMax} A ${rMax} ${rMax} 0 1 0 ${CENTER} ${CENTER-rMax} Z`} fill="rgba(34, 197, 94, 0.2)" fillRule="evenodd" />;
                } else if (sequenceType === SequenceType.LEFT_SIDED) {
                  return <circle cx={CENTER} cy={CENTER} r={rMin} fill="rgba(59, 130, 246, 0.2)" />;
                } else {
                  if (poles.length < 2) return null;
                  return <path d={`M ${CENTER} ${CENTER-rMax} A ${rMax} ${rMax} 0 1 1 ${CENTER} ${CENTER+rMax} A ${rMax} ${rMax} 0 1 1 ${CENTER} ${CENTER-rMax} Z M ${CENTER} ${CENTER-rMin} A ${rMin} ${rMin} 0 1 0 ${CENTER} ${CENTER+rMin} A ${rMin} ${rMin} 0 1 0 ${CENTER} ${CENTER-rMin} Z`} fill="rgba(234, 179, 8, 0.2)" fillRule="evenodd" />;
                }
            };

            return (
                <div id="zplane-container" className="relative bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden cursor-crosshair">
                <svg ref={svgRef} viewBox={`0 0 ${SVG_SIZE} ${SVG_SIZE}`} onMouseMove={handleMouseMove} onMouseUp={handleMouseUp} onMouseLeave={handleMouseUp} className="block select-none" id="zplane-svg">
                    <defs>
                        <pattern id="grid" width="25" height="25" patternUnits="userSpaceOnUse">
                            <path d="M 25 0 L 0 0 0 25" fill="none" stroke="gray" strokeWidth="0.5" strokeOpacity="0.1"/>
                        </pattern>
                    </defs>
                    <rect width="100%" height="100%" fill="url(#grid)" />
                    <line x1={0} y1={CENTER} x2={SVG_SIZE} y2={CENTER} stroke="#9ca3af" strokeWidth="2" />
                    <line x1={CENTER} y1={0} x2={CENTER} y2={SVG_SIZE} stroke="#9ca3af" strokeWidth="2" />
                    <text x={SVG_SIZE - 10} y={CENTER + 20} textAnchor="end" className="text-xs fill-gray-500 font-mono">Re(z)</text>
                    <text x={CENTER + 10} y={20} className="text-xs fill-gray-500 font-mono">Im(z)</text>
                    {renderROC()}
                    <circle cx={CENTER} cy={CENTER} r={UNIT_RADIUS} fill="none" stroke="#ef4444" strokeWidth="1.5" strokeDasharray="5,5" className="pointer-events-none" />
                    <text x={CENTER + UNIT_RADIUS + 5} y={CENTER + 20} className="text-xs fill-red-500 font-semibold">|z|=1</text>
                    {poles.map((pole) => {
                        const pos = logicalToScreen(pole.position.x, pole.position.y);
                        const isDragging = draggingItem?.id === pole.id && draggingItem?.type === 'pole';
                        return (
                            <g key={pole.id} onMouseDown={(e) => handleMouseDown(pole.id, 'pole', e)} className="cursor-move group">
                                <circle cx={pos.x} cy={pos.y} r={20} fill="transparent" />
                                <line x1={pos.x - 6} y1={pos.y - 6} x2={pos.x + 6} y2={pos.y + 6} stroke={isDragging ? "#dc2626" : "#000"} strokeWidth={3} className="group-hover-stroke-red"/>
                                <line x1={pos.x + 6} y1={pos.y - 6} x2={pos.x - 6} y2={pos.y + 6} stroke={isDragging ? "#dc2626" : "#000"} strokeWidth={3} className="group-hover-stroke-red"/>
                            </g>
                        );
                    })}
                    {zeros.map((zero) => {
                        const pos = logicalToScreen(zero.position.x, zero.position.y);
                        const isDragging = draggingItem?.id === zero.id && draggingItem?.type === 'zero';
                        return (
                            <g key={zero.id} onMouseDown={(e) => handleMouseDown(zero.id, 'zero', e)} className="cursor-move group">
                                <circle cx={pos.x} cy={pos.y} r={20} fill="transparent" />
                                <circle cx={pos.x} cy={pos.y} r={6} fill="none" stroke={isDragging ? "#2563eb" : "#1d4ed8"} strokeWidth={3} className="group-hover-stroke-blue" />
                            </g>
                        );
                    })}
                </svg>
                </div>
            );
        };

        const TimeDomainPlot = ({ poles, zeros, sequenceType }) => {
            const WIDTH = 600; const HEIGHT = 200; const PADDING = 40; const X_AXIS_Y = HEIGHT / 2;

            const nValues = useMemo(() => {
                const indices = [];
                if (sequenceType === SequenceType.RIGHT_SIDED) for (let i = -5; i <= 30; i++) indices.push(i);
                else if (sequenceType === SequenceType.LEFT_SIDED) for (let i = -30; i <= 5; i++) indices.push(i);
                else for (let i = -20; i <= 20; i++) indices.push(i);
                return indices;
            }, [sequenceType]);

            const dataPoints = useMemo(() => {
                const sortedPoles = [...poles].sort((a, b) => a.magnitude - b.magnitude);
                const splitIndex = Math.floor(sortedPoles.length / 2);
                
                // Implicit Zeros Logic
                const computationalZeros = zeros.map(z => toComplex(z));
                while (computationalZeros.length < poles.length) computationalZeros.push({ re: 0, im: 0 });

                return nValues.map((n) => {
                    let sumRe = 0;
                    sortedPoles.forEach((pole, index) => {
                        let isCausal = false;
                        if (sequenceType === SequenceType.RIGHT_SIDED) isCausal = true;
                        else if (sequenceType === SequenceType.LEFT_SIDED) isCausal = false;
                        else { if (sortedPoles.length === 1) isCausal = pole.magnitude < 1; else isCausal = index < splitIndex; }
                        
                        const p_k = toComplex(pole);
                        if (Math.abs(p_k.re) < 0.001 && Math.abs(p_k.im) < 0.001) return;

                        let numerator = { re: 1, im: 0 };
                        if (computationalZeros.length > 0) {
                            computationalZeros.forEach(z_m => { numerator = cMul(numerator, cSub(p_k, z_m)); });
                        }
                        let denominator = p_k;
                        sortedPoles.forEach((other, otherIndex) => {
                            if (index !== otherIndex) denominator = cMul(denominator, cSub(p_k, toComplex(other)));
                        });
                        
                        const residue = cDiv(numerator, denominator);
                        const mode = complexPow(pole.magnitude, pole.angle, n);
                        const term = cMul(residue, mode);

                        if (isCausal) { if (n >= 0) sumRe += term.re; } else { if (n < 0) sumRe -= term.re; }
                    });
                    return { n, val: sumRe };
                });
            }, [poles, zeros, sequenceType, nValues]);

            const maxAbsVal = Math.max(...dataPoints.map(d => Math.abs(d.val)), 0.001);
            const plotScaleY = (HEIGHT / 2 - PADDING) / (Math.min(maxAbsVal, 100));
            const minN = nValues[0]; const maxN = nValues[nValues.length - 1];
            const plotScaleX = (WIDTH - PADDING * 2) / (maxN - minN);
            const getX = (n) => PADDING + (n - minN) * plotScaleX;
            const getY = (val) => {
                let clampedVal = val; if (val > 100) clampedVal = 100; if (val < -100) clampedVal = -100;
                return X_AXIS_Y - clampedVal * plotScaleY;
            };

            return (
                <div className="bg-white p-4 rounded-xl shadow-lg border border-gray-200 mt-6">
                <div className="flex justify-between items-center mb-2">
                    <h3 className="text-lg font-bold text-gray-800">Time-Domain Impulse Response h[n]</h3>
                    <span className="text-xs font-mono text-gray-500 bg-gray-100 px-2 py-1 rounded">Max Amp: {maxAbsVal > 1000 ? '>1000' : maxAbsVal.toFixed(2)}</span>
                </div>
                <div className="overflow-x-auto">
                    <svg width={WIDTH} height={HEIGHT} className="mx-auto select-none" style={{maxWidth: '100%', height: 'auto'}}>
                    <rect x={PADDING} y={PADDING} width={WIDTH - PADDING*2} height={HEIGHT - PADDING*2} fill="#f9fafb" />
                    <line x1={PADDING} y1={X_AXIS_Y} x2={WIDTH - PADDING} y2={X_AXIS_Y} stroke="#9ca3af" strokeWidth={2} />
                    <line x1={getX(0)} y1={PADDING} x2={getX(0)} y2={HEIGHT - PADDING} stroke="#e5e7eb" strokeWidth={2} strokeDasharray="4,4" />
                    {dataPoints.map((pt) => {
                        const x = getX(pt.n); const y = getY(pt.val);
                        const isClipped = Math.abs(pt.val) > 100; const color = isClipped ? "#ef4444" : "#4f46e5";
                        return (
                        <g key={pt.n} className="group">
                            <line x1={x} y1={X_AXIS_Y} x2={x} y2={y} stroke={color} strokeWidth={2} />
                            <circle cx={x} cy={y} r={isClipped ? 2 : 3} fill={isClipped ? "white" : color} stroke={color} strokeWidth={isClipped ? 2 : 0} className="group-hover-scale" />
                        </g>
                        );
                    })}
                    </svg>
                </div>
                </div>
            );
        };

        const TheoryPanel = ({ poles, sequenceType }) => {
          const magnitudes = poles.map(p => p.magnitude);
          const maxMag = magnitudes.length > 0 ? Math.max(...magnitudes) : 0;
          const minMag = magnitudes.length > 0 ? Math.min(...magnitudes) : 0;
          const renderContent = () => {
             if (sequenceType === SequenceType.RIGHT_SIDED) {
               return (
                <div className="space-y-4">
                  <div className="p-3 bg-blue-50 border-l-4 border-blue-500 rounded-r"><h4 className="font-bold text-blue-900 text-sm">Right-Sided Sequence (Causal)</h4></div>
                  <div className="bg-gray-100 p-2 rounded text-center font-mono text-sm">|z| &gt; {maxMag.toFixed(2)}</div>
                  <p className="text-sm text-gray-600 italic">ROC outside circle.</p>
                </div>
               );
             } else if (sequenceType === SequenceType.LEFT_SIDED) {
               return (
                <div className="space-y-4">
                  <div className="p-3 bg-indigo-50 border-l-4 border-indigo-500 rounded-r"><h4 className="font-bold text-indigo-900 text-sm">Left-Sided Sequence (Anti-Causal)</h4></div>
                  <div className="bg-gray-100 p-2 rounded text-center font-mono text-sm">|z| &lt; {minMag.toFixed(2)}</div>
                  <p className="text-sm text-gray-600 italic">ROC inside circle.</p>
                </div>
               );
             } else {
               return (
                <div className="space-y-4">
                 <div className="p-3 bg-yellow-50 border-l-4 border-yellow-500 rounded-r"><h4 className="font-bold text-yellow-900 text-sm">Two-Sided Sequence</h4></div>
                 <div className="bg-green-50 px-4 py-3 border border-green-200 rounded shadow-sm font-mono font-bold text-green-800 text-center">{minMag.toFixed(2)} &lt; |z| &lt; {maxMag.toFixed(2)}</div>
                </div>
               );
             }
          };
          return (
             <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mt-6">
                 <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">Definition & ROC Meaning</h3>
                 {poles.length === 0 ? <p className="text-gray-500 italic">Add poles to see derivation.</p> : renderContent()}
             </div>
          )
        };

        const InfoPanel = ({ poles, zeros, sequenceType }) => {
            const magnitudes = poles.map(p => p.magnitude);
            const maxMag = magnitudes.length > 0 ? Math.max(...magnitudes) : 0;
            const minMag = magnitudes.length > 0 ? Math.min(...magnitudes) : 0;
            
            // Stability Logic
            let isStable = false;
            let stabilityReason = "";
            if (poles.length === 0) {
                stabilityReason = "No poles defined.";
            } else {
                if (sequenceType === SequenceType.RIGHT_SIDED) {
                    isStable = maxMag < 1;
                    stabilityReason = isStable ? "Stable: All poles inside unit circle." : "Unstable: Pole outside/on unit circle.";
                } else if (sequenceType === SequenceType.LEFT_SIDED) {
                    isStable = minMag > 1;
                    stabilityReason = isStable ? "Stable: Unit circle included." : "Unstable: Unit circle not included.";
                } else {
                    isStable = minMag < 1 && maxMag > 1;
                    stabilityReason = isStable ? "Stable: Unit circle in ring." : "Unstable: Unit circle not in ring.";
                }
            }

            const rocText = () => {
                if (poles.length === 0) return "Entire Z-plane";
                if (sequenceType === SequenceType.RIGHT_SIDED) return `|z| > ${maxMag.toFixed(2)}`;
                if (sequenceType === SequenceType.LEFT_SIDED) return `|z| < ${minMag.toFixed(2)}`;
                return `${minMag.toFixed(2)} < |z| < ${maxMag.toFixed(2)}`;
            };

            return (
                <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h3 className="text-lg font-bold text-gray-800 mb-4">System Analysis</h3>
                    <div className="space-y-4">
                        <div className="p-4 bg-gray-50 rounded-lg border border-gray-100">
                            <p className="text-xs font-semibold text-gray-500 uppercase tracking-wide">ROC Equation</p>
                            <p className="text-xl font-mono text-indigo-600 font-bold mt-1">{rocText()}</p>
                        </div>

                        <div className={`p-4 rounded-lg border ${isStable ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
                            <p className="text-xs font-semibold uppercase tracking-wide flex items-center gap-2">
                                <span className={`w-2 h-2 rounded-full ${isStable ? 'bg-green-500' : 'bg-red-500'}`}></span>
                                {isStable ? 'Stable System' : 'Unstable System'}
                            </p>
                            <p className="text-sm mt-1 text-gray-700">{stabilityReason}</p>
                        </div>
                        
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <p className="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Poles (X)</p>
                                <div className="max-h-32 overflow-y-auto space-y-1">
                                    {poles.map((p, idx) => (
                                        <div key={p.id} className="flex justify-between text-sm bg-gray-50 px-2 py-1 rounded">
                                            <span>p{idx+1}</span>
                                            <span className="font-mono">{p.magnitude.toFixed(2)}∠{(p.angle * (180/Math.PI)).toFixed(0)}°</span>
                                        </div>
                                    ))}
                                    {poles.length === 0 && <span className="text-sm text-gray-400 italic">None</span>}
                                </div>
                            </div>
                            <div>
                                <p className="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Zeros (O)</p>
                                <div className="max-h-32 overflow-y-auto space-y-1">
                                    {zeros.map((z, idx) => (
                                        <div key={z.id} className="flex justify-between text-sm bg-blue-50 px-2 py-1 rounded">
                                            <span>z{idx+1}</span>
                                            <span className="font-mono">{z.magnitude.toFixed(2)}∠{(z.angle * (180/Math.PI)).toFixed(0)}°</span>
                                        </div>
                                    ))}
                                    {zeros.length === 0 && <span className="text-sm text-gray-400 italic">None</span>}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ControlPanel = ({ poles, zeros, sequenceType, setSequenceType, addPole, removeLastPole, addZero, removeLastZero, onUpdatePoles, onUpdateZeros, reset }) => {
            const updatePole = (index, updates) => {
                const newPoles = [...poles];
                const pole = newPoles[index];
                let mag = pole.magnitude;
                let angle = pole.angle;

                if (updates.mag !== undefined) mag = updates.mag;
                if (updates.angleDeg !== undefined) angle = updates.angleDeg * (Math.PI / 180);

                newPoles[index] = {
                    ...pole,
                    magnitude: mag,
                    angle: angle,
                    position: {
                        x: mag * Math.cos(angle),
                        y: mag * Math.sin(angle)
                    }
                };
                onUpdatePoles(newPoles);
            };

            const updateZero = (index, updates) => {
                const newZeros = [...zeros];
                const zero = newZeros[index];
                
                let mag = zero.magnitude;
                let angle = zero.angle;

                if (updates.mag !== undefined) mag = updates.mag;
                if (updates.angleDeg !== undefined) angle = updates.angleDeg * (Math.PI / 180);

                newZeros[index] = {
                    ...zero,
                    magnitude: mag,
                    angle: angle,
                    position: {
                        x: mag * Math.cos(angle),
                        y: mag * Math.sin(angle)
                    }
                };
                onUpdateZeros(newZeros);
            };

            return (
                <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200 h-full flex flex-col">
                    <h2 className="text-xl font-bold text-gray-800 mb-4">Configuration</h2>
                    
                    <div className="flex-1 overflow-y-auto min-h-0 pr-2 -mr-2 space-y-6 pb-4">
                        {/* Sequence Type */}
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Sequence Type</label>
                            <div className="flex flex-col gap-2">
                                {Object.values(SequenceType).map(t => (
                                <button key={t} onClick={() => setSequenceType(t)} className={`px-4 py-3 rounded-lg text-sm text-left border ${sequenceType === t ? 'bg-blue-600 text-white border-blue-600' : 'bg-gray-50 text-gray-700 border-gray-200'}`}>{t}</button>
                                ))}
                            </div>
                        </div>

                        {/* Poles */}
                        <div>
                            <div className="flex items-center justify-between mb-2">
                                <label className="block text-sm font-medium text-gray-700">Poles (X) - {poles.length}</label>
                            </div>
                            <div className="flex gap-2 mb-3">
                                <button onClick={addPole} className="flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800 transition-colors text-sm"><PlusIcon className="w-4 h-4" /> Add</button>
                                <button onClick={removeLastPole} disabled={poles.length === 0} className="flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-red-50 text-red-600 border border-red-200 rounded-lg hover:bg-red-100 disabled:opacity-50 transition-colors text-sm"><TrashIcon className="w-4 h-4" /> Remove</button>
                            </div>
                            <div className="space-y-3">
                                {poles.map((pole, idx) => (
                                    <div key={pole.id} className="bg-gray-50 p-3 rounded-lg border border-gray-200 text-xs">
                                        <div className="font-semibold text-gray-500 mb-2 flex justify-between"><span>Pole {idx + 1}</span></div>
                                        {/* Mag */}
                                        <div className="flex items-center gap-2 mb-2">
                                            <span className="w-8 font-medium text-gray-600">Mag</span>
                                            <input type="range" min="0" max="2" step="0.01" value={pole.magnitude} onChange={(e) => updatePole(idx, { mag: parseFloat(e.target.value) })} className="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600" />
                                            <span className="w-10 text-right font-mono text-gray-700">{pole.magnitude.toFixed(2)}</span>
                                        </div>
                                        {/* Phase */}
                                        <div className="flex items-center gap-2">
                                            <span className="w-8 font-medium text-gray-600">Arg</span>
                                            <input type="range" min="-180" max="180" step="1" value={pole.angle * (180/Math.PI)} onChange={(e) => updatePole(idx, { angleDeg: parseFloat(e.target.value) })} className="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600" />
                                            <span className="w-10 text-right font-mono text-gray-700">{(pole.angle * (180/Math.PI)).toFixed(0)}°</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Zeros */}
                        <div>
                            <div className="flex items-center justify-between mb-2">
                                <label className="block text-sm font-medium text-gray-700">Zeros (O) - {zeros.length}</label>
                            </div>
                            <div className="flex gap-2 mb-3">
                                <button onClick={addZero} className="flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm"><PlusIcon className="w-4 h-4" /> Add</button>
                                <button onClick={removeLastZero} disabled={zeros.length === 0} className="flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-blue-50 text-blue-600 border border-blue-200 rounded-lg hover:bg-blue-100 disabled:opacity-50 transition-colors text-sm"><TrashIcon className="w-4 h-4" /> Remove</button>
                            </div>
                            <div className="space-y-3">
                                {zeros.map((zero, idx) => (
                                    <div key={zero.id} className="bg-blue-50 p-3 rounded-lg border border-blue-200 text-xs">
                                        <div className="font-semibold text-blue-800 mb-2 flex justify-between"><span>Zero {idx + 1}</span></div>
                                        {/* Mag */}
                                        <div className="flex items-center gap-2 mb-2">
                                            <span className="w-8 font-medium text-blue-700">Mag</span>
                                            <input type="range" min="0" max="2" step="0.01" value={zero.magnitude} onChange={(e) => updateZero(idx, { mag: parseFloat(e.target.value) })} className="flex-1 h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer accent-blue-600" />
                                            <span className="w-10 text-right font-mono text-blue-800">{zero.magnitude.toFixed(2)}</span>
                                        </div>
                                        {/* Phase */}
                                        <div className="flex items-center gap-2">
                                            <span className="w-8 font-medium text-blue-700">Arg</span>
                                            <input type="range" min="-180" max="180" step="1" value={zero.angle * (180/Math.PI)} onChange={(e) => updateZero(idx, { angleDeg: parseFloat(e.target.value) })} className="flex-1 h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer accent-blue-600" />
                                            <span className="w-10 text-right font-mono text-blue-800">{(zero.angle * (180/Math.PI)).toFixed(0)}°</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    <div className="mt-auto pt-4 border-t border-gray-100 flex flex-col gap-3 flex-shrink-0">
                        <button onClick={reset} className="w-full text-center text-sm text-gray-500 underline mb-4">Reset to Default</button>
                        <div className="bg-yellow-50 text-yellow-800 text-xs p-3 rounded border border-yellow-200 text-center">
                            Offline Mode Active
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const initialState = {"poles":[{"id":"1","position":{"x":0.5,"y":0.5},"magnitude":0.7071067811865476,"angle":0.7853981633974483}],"zeros":[],"sequenceType":"Right-Sided (Causal)"};
            const [poles, setPoles] = useState(initialState.poles);
            const [zeros, setZeros] = useState(initialState.zeros);
            const [sequenceType, setSequenceType] = useState(initialState.sequenceType);

            const addPole = () => {
                const offset = poles.length * 0.1;
                const newPole = { id: Date.now().toString(), position: { x: 0.3 + offset, y: -0.3 - offset }, magnitude: Math.sqrt(Math.pow(0.3+offset, 2) + Math.pow(-0.3-offset, 2)), angle: Math.atan2(-0.3-offset, 0.3+offset) };
                setPoles([...poles, newPole]);
            };
            const removeLastPole = () => setPoles(poles.slice(0, -1));
            
            const addZero = () => {
                const offset = zeros.length * 0.1;
                const newZero = { id: Date.now().toString() + "_z", position: { x: -0.3 - offset, y: 0.3 + offset }, magnitude: Math.sqrt(Math.pow(-0.3-offset, 2) + Math.pow(0.3+offset, 2)), angle: Math.atan2(0.3+offset, -0.3-offset) };
                setZeros([...zeros, newZero]);
            };
            const removeLastZero = () => setZeros(zeros.slice(0, -1));

            const reset = () => {
                setPoles(initialState.poles);
                setZeros(initialState.zeros);
                setSequenceType(initialState.sequenceType);
            };

            return (
                <div className="min-h-screen pb-12">
                    <header className="bg-white border-b border-gray-200 sticky top-0 z-10">
                        <div className="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold">Z</div>
                                <h1 className="text-xl font-bold text-gray-900">Z-Transform ROC Visualizer (Offline)</h1>
                            </div>
                        </div>
                    </header>
                    <main className="max-w-7xl mx-auto px-4 py-8">
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div className="lg:col-span-2 flex flex-col gap-6">
                                <ZPlane poles={poles} zeros={zeros} sequenceType={sequenceType} onUpdatePoles={setPoles} onUpdateZeros={setZeros} />
                                <TimeDomainPlot poles={poles} zeros={zeros} sequenceType={sequenceType} />
                                <TheoryPanel poles={poles} sequenceType={sequenceType} />
                                <InfoPanel poles={poles} zeros={zeros} sequenceType={sequenceType} />
                            </div>
                            <div className="lg:col-span-1 h-[800px] lg:h-auto lg:sticky lg:top-24">
                                <ControlPanel 
                                    poles={poles} zeros={zeros} sequenceType={sequenceType} setSequenceType={setSequenceType} 
                                    addPole={addPole} removeLastPole={removeLastPole} 
                                    addZero={addZero} removeLastZero={removeLastZero} 
                                    onUpdatePoles={setPoles} onUpdateZeros={setZeros}
                                    reset={reset} 
                                />
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
